<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BlackHawk Data — Local Ops Dashboard</title>
  <meta name="description" content="Local dashboard for traffic, weather, subway ETAs, and nearby street cameras around 505 8th Ave, Suite 303, New York, NY 10018." />

  <style>
    :root {
      --brand-blue: #0d5bd3;
      --brand-blue-2: #093a8a;
      --brand-accent: #5aa6ff;
      --bg: #0a0f1a;
      --surface: #0f172a;
      --text: #e6edf3;
      --muted: #9fb1c7;
      --tile-border: rgba(255,255,255,0.10);
      --radius: 18px;
      --shadow: 0 10px 28px rgba(0,0,0,0.45);
      --gap: 18px;
      --square-aspect: 4 / 3; /* 4:3 by default; change to 1/1 for perfect squares */
    }
    [data-theme="light"] {
      --bg: #f6f8fb;
      --surface: #ffffff;
      --text: #0b1220;
      --muted: #53657d;
      --tile-border: rgba(10,15,26,0.10);
      --shadow: 0 8px 24px rgba(6, 15, 38, 0.08);
    }

    * { box-sizing: border-box; }
    html, body {
      height: 100%;
      margin: 0;
      color: var(--text);
      font-family: "Inter", ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background: radial-gradient(1200px 800px at 20% -10%, rgba(13,91,211,0.15), transparent),
                  radial-gradient(1000px 800px at 120% 10%, rgba(9,58,138,0.12), transparent),
                  var(--bg);
      line-height: 1.35;
    }
    a { color: var(--text); }
    a.ghost { color: var(--muted); text-decoration: none; border-bottom: 1px dashed rgba(255,255,255,0.35); }
    [data-theme="light"] a.ghost { border-bottom-color: rgba(11,18,32,0.35); }
    a.ghost:hover { color: var(--text); }

    header {
      display: grid; grid-template-columns: 1fr auto auto; align-items: center;
      gap: var(--gap); padding: 18px clamp(16px, 4vw, 40px);
      border-bottom: 1px solid var(--tile-border);
      background: linear-gradient(180deg, rgba(13,91,211,0.10), transparent);
      position: sticky; top: 0; z-index: 20; backdrop-filter: blur(6px);
    }
    .brand { display: flex; align-items: center; gap: 14px; min-width: 0; }
    .brand img { height: 42px; width: auto; }
    .brand h1 { margin: 0; font-weight: 650; letter-spacing: .2px; font-size: clamp(16px, 2.2vw, 20px); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

    .clock { display: grid; grid-auto-flow: column; align-items: center; gap: 10px; padding: 10px 14px; border: 1px solid var(--tile-border); border-radius: var(--radius);
      background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01)); box-shadow: var(--shadow); }
    .time { font-variant-numeric: tabular-nums; font-family: ui-monospace, Menlo, Consolas, Monaco, "Segoe UI Mono", monospace; font-size: clamp(20px, 4vw, 36px); letter-spacing: 1px; }
    .date { font-size: clamp(11px, 1.8vw, 13px); color: var(--muted); text-align: right; }

    .theme-toggle { display: inline-flex; align-items: center; gap: 10px; padding: 8px 12px; border: 1px solid var(--tile-border); border-radius: 999px;
      background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01)); cursor: pointer; user-select: none; }
    .dot { width: 14px; height: 14px; border-radius: 50%; background: var(--brand-blue);
      box-shadow: 0 0 0 4px rgba(13,91,211,0.15), inset 0 0 0 2px rgba(255,255,255,0.5); }

    main { padding: 20px clamp(16px, 4vw, 40px) 40px; }

    /* Grid with cameras directly under subway, and traffic/weather pinned to bottom via spacer */
    .grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      grid-template-areas:
        "subway subway"
        "cams cams"
        "spacer spacer"
        "traffic weather";
      grid-template-rows: auto auto 1fr auto;
      gap: var(--gap);
      min-height: calc(100dvh - 0px);
      align-items: end;
    }

    .tile { background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border: 1px solid var(--tile-border); border-radius: var(--radius);
      box-shadow: var(--shadow); overflow: hidden; display: flex; flex-direction: column; min-height: 180px; }
    .tile h2 { margin: 0; padding: 12px 16px; font-weight: 600; font-size: 15px; letter-spacing: 0.2px; border-bottom: 1px solid var(--tile-border);
      display: flex; align-items: center; justify-content: space-between; background: linear-gradient(180deg, rgba(13,91,211,0.16), rgba(13,91,211,0.05)); }
    .tile h2 .links { display: flex; gap: 10px; align-items: center; font-size: 12px; color: var(--muted); }
    .tile .body { position: relative; flex: 1; display: grid; place-items: stretch; padding: 0; }
    iframe { width: 100%; height: 100%; border: 0; display: block; background: #0a0f1a; }

    /* Area assignments */
    #tile-subway { grid-area: subway; }
    #tile-cams { grid-area: cams; }
    .spacer { grid-area: spacer; min-height: 0; }
    #tile-traffic { grid-area: traffic; align-self: end; }
    #tile-weather { grid-area: weather; align-self: end; }

    /* Square/Aspect-ratio helpers for middle tiles */
    .square .body { aspect-ratio: var(--square-aspect); }
    .square .body > * { height: 100%; width: 100%; }

    /* Camera grid */
    .cams { padding: 14px; display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 14px; align-content: start; }
    .cam { border: 1px solid var(--tile-border); border-radius: 14px; overflow: hidden; background: rgba(255,255,255,0.02);
           display: grid; grid-template-rows: auto auto 36px; }
    .cam img { width: 100%; height: 180px; object-fit: cover; display: block; background: #000; }
    .cam .addr { padding: 8px 10px; font-size: 12px; color: var(--muted); background: rgba(255,255,255,0.02); }
    .cam footer { display: flex; align-items: center; justify-content: space-between; gap: 10px; padding: 8px 10px; font-size: 12px; color: var(--muted); background: rgba(13,91,211,0.06); }
    .pill { border: 1px solid rgba(255,255,255,0.2); padding: 2px 8px; border-radius: 999px; font-size: 11px; color: #cfe2ff; background: linear-gradient(180deg, rgba(13,91,211,0.25), rgba(255,255,255,0.04)); white-space: nowrap; }
    [data-theme="light"] .pill { color: #093a8a; background: rgba(13,91,211,0.12); border-color: rgba(9,58,138,0.25); }

    /* Transit tile */
    .transit-grid { padding: 14px; display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 14px; align-content: start; }
    .route { border: 1px solid var(--tile-border); border-radius: 14px; background: rgba(255,255,255,0.02); display: grid; grid-template-rows: auto auto auto; }
    .route header { padding: 10px 12px; font-weight: 600; display: flex; justify-content: space-between; align-items: center; gap: 8px; border-bottom: 1px solid var(--tile-border); }
    .eta { font-size: 22px; font-weight: 700; padding: 8px 12px; }
    .via { padding: 0 12px 10px 12px; color: var(--muted); font-size: 12px; }
    .actions { display: flex; padding: 8px 12px 12px; gap: 8px; }
    .btn { display: inline-block; padding: 7px 10px; border: 1px solid var(--tile-border); border-radius: 10px; text-decoration: none; font-size: 12px;
           background: linear-gradient(180deg, rgba(255,255,255,0.05), rgba(255,255,255,0.02)); color: var(--text); }

    @media (max-width: 900px) {
      .grid {
        grid-template-columns: 1fr;
        grid-template-areas: "subway" "cams" "traffic" "weather";
        grid-template-rows: auto auto auto auto;
        min-height: auto;
      }
      .square .body { aspect-ratio: auto; }
    }
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <img alt="BlackHawk Data" src="https://blackhawk11.com/wp-content/uploads/2024/12/new-blue-bhd-horizontal-black-blue.png" />
      <h1>BlackHawk Data — Local Ops Dashboard</h1>
    </div>

    <div class="clock" aria-live="polite">
      <div class="time" id="clock">--:--:--</div>
      <div class="date" id="date">Loading...</div>
    </div>

    <button id="themeToggle" class="theme-toggle" title="Toggle theme">
      <span class="dot" aria-hidden="true"></span>
      <span id="themeLabel">Dark</span>
    </button>
  </header>

  <main>
    <div class="grid" id="grid">
      <!-- SUBWAY (top) -->
      <section id="tile-subway" class="tile" aria-label="Subway travel times">
        <h2>
          Subway Travel Times — from 34 St–Penn Station
          <span class="links">
            <span class="pill" id="peakBadge">Off-peak estimate</span>
            <a class="ghost" target="_blank" rel="noopener" href="https://citymapper.com/meet?lang=en">Citymapper</a>
          </span>
        </h2>
        <div class="transit-grid" id="transitGrid"></div>
      </section>

      <!-- CAMERAS (now directly under Subway) -->
      <section id="tile-cams" class="tile" aria-label="Nearby street cameras">
        <h2>
          Nearby Live Street Cameras
          <span class="links">
            <span class="pill">NYC DOT (still images)</span>
            <a class="ghost" target="_blank" rel="noopener" href="https://webcams.nyctmc.org/cameras-list">NYC DOT Cameras List</a>
          </span>
        </h2>
        <div id="cams" class="cams" aria-live="polite"></div>
      </section>

      <div class="spacer" aria-hidden="true"></div>

      <!-- TRAFFIC (Waze, bottom, aspect 4:3) -->
      <section id="tile-traffic" class="tile square" aria-label="Traffic around 505 8th Ave">
        <h2>
          Live Traffic (Waze)
          <span class="links">
            <span class="pill">Real-time</span>
            <a class="ghost" target="_blank" rel="noopener" href="https://www.waze.com/live-map/directions?to=ll.40.7529%2C-73.9934">Open Waze</a>
          </span>
        </h2>
        <div class="body">
          <iframe
            title="Waze Live Traffic — Midtown Manhattan"
            src="https://embed.waze.com/iframe?zoom=14&lat=40.7529&lon=-73.9934&pin=1&ct=livemap"
            referrerpolicy="no-referrer-when-downgrade"
            loading="lazy"
            allowfullscreen
          ></iframe>
        </div>
      </section>

      <!-- WEATHER (Windy, bottom, aspect 4:3) -->
      <section id="tile-weather" class="tile square" aria-label="Weather near 505 8th Ave">
        <h2>
          Weather (Windy)
          <span class="links">
            <span class="pill">505 8th Ave</span>
            <a class="ghost" target="_blank" rel="noopener" href="https://www.windy.com/?40.7529,-73.9934,12">Open Windy</a>
          </span>
        </h2>
        <div class="body">
          <iframe
            title="Windy Weather — Midtown Manhattan"
            src="https://embed.windy.com/embed2.html?lat=40.7529&lon=-73.9934&detailLat=40.7529&detailLon=-73.9934&zoom=12&level=surface&overlay=wind&product=ecmwf&menu=&message=true&marker=true&calendar=now&pressure=true&type=map&location=coordinates&detail=true&metricWind=mph&metricTemp=%C2%B0F"
            loading="lazy"
          ></iframe>
        </div>
      </section>
    </div>
  </main>

  <script>
    "use strict";

    // --- Clock ---
    (function initClock(){
      const clockEl = document.getElementById('clock');
      const dateEl = document.getElementById('date');
      const pad = (n) => String(n).padStart(2, '0');
      function render(){
        const now = new Date();
        let h = now.getHours();
        const ampm = h >= 12 ? 'PM' : 'AM';
        h = h % 12 || 12;
        clockEl.textContent = `${pad(h)}:${pad(now.getMinutes())}:${pad(now.getSeconds())} ${ampm}`;
        dateEl.textContent = now.toLocaleDateString(undefined, { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric' });
      }
      render(); setInterval(render, 1000);
    })();

    // --- Theme Toggle ---
    (function initTheme(){
      const root = document.documentElement;
      const btn = document.getElementById('themeToggle');
      const label = document.getElementById('themeLabel');
      const saved = localStorage.getItem('bhd.theme');
      const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
      const initial = saved || (prefersDark ? 'dark' : 'light');
      setTheme(initial);
      btn.addEventListener('click', () => setTheme(root.getAttribute('data-theme') === 'dark' ? 'light' : 'dark'));
      function setTheme(mode){ root.setAttribute('data-theme', mode); localStorage.setItem('bhd.theme', mode); label.textContent = mode[0].toUpperCase() + mode.slice(1); }
    })();

    // --- Cameras with address under image ---
    const HQ = { lat: 40.7529, lon: -73.9934 };
    const CAM_REFRESH_MS = 5000;

    const fallbackUUIDs = [
      { id: '907af141-b289-47d3-9f41-edc7667cff7e', name: 'NYC DOT Camera', area: 'Manhattan' },
      { id: 'eafc65f5-6ff9-4203-905f-3995b9fbc9eb', name: 'NYC DOT Camera', area: 'Manhattan' },
      { id: 'e184e99b-6bbd-4dd7-a36b-ad17ca50ad36', name: 'NYC DOT Camera', area: 'Manhattan' },
      { id: 'e179ded3-4cdc-4110-ac9c-f12c20f9ccad', name: 'NYC DOT Camera', area: 'Manhattan' },
      { id: 'b59bd3d2-0d72-4a65-8316-e79491c622e3', name: 'NYC DOT Camera', area: 'Manhattan' },
      { id: '053e8995-f8cb-4d02-a659-70ac7c7da5db', name: 'NYC DOT Camera', area: 'Manhattan' }
    ];

    function toRad(d){ return d*Math.PI/180; }
    function haversine(a,b){
      const R=6371, dLat=toRad(b.lat-a.lat), dLon=toRad(b.lon-a.lon);
      const lat1=toRad(a.lat), lat2=toRad(b.lat);
      const h = Math.sin(dLat/2)**2 + Math.cos(lat1)*Math.cos(lat2)*Math.sin(dLon/2)**2;
      return 2*R*Math.asin(Math.sqrt(h));
    }
    function nameToAddress(name, area){
      if (!name) return (area ? area + ', ' : '') + 'New York, NY';
      const pretty = name.replace(/\s*@\s*/g, ' & ').replace(/\s+/g,' ').trim();
      return `${pretty}, ${area ? area + ', ' : ''}NY`;
    }

    async function getNearbyCameras(){
      try {
        const res = await fetch('https://webcams.nyctmc.org/api/cameras', { cache: 'no-store' });
        if (!res.ok) throw new Error('HTTP ' + res.status);
        const all = await res.json();
        let pool = all.filter(c => (c && c.latitude && c.longitude && (c.area||'').toLowerCase()==='manhattan'));
        pool = pool.map(c => ({ ...c, dist: haversine(HQ, {lat:c.latitude, lon:c.longitude}) }));
        pool.sort((a,b)=>a.dist-b.dist);
        const near = pool.filter(c => c.dist <= 2).slice(0,6);
        const chosen = near.length >= 6 ? near : pool.slice(0,6);
        return chosen.map(c => ({
          id: c.id,
          name: c.name || 'NYC DOT Camera',
          area: c.area || 'Manhattan',
          distkm: c.dist,
          address: nameToAddress(c.name, c.area)
        }));
      } catch (e) {
        console.warn('NYCTMC discovery failed; using fallback cameras.', e);
        return [];
      }
    }

    function renderCameras(list){
      const wrap = document.getElementById('cams'); wrap.innerHTML = '';
      if (!list.length) {
        list = fallbackUUIDs.map(c => ({ ...c, address: nameToAddress(c.name, c.area) }));
      }
      list.forEach(c => {
        const card = document.createElement('div'); card.className = 'cam';

        const img = document.createElement('img');
        img.alt = c.name;
        img.loading = 'lazy';
        img.decoding = 'async';
        img.referrerPolicy = 'no-referrer';
        const mkSrc = () => `https://webcams.nyctmc.org/api/cameras/${c.id}/image?t=${Date.now()}`;
        img.src = mkSrc();
        setInterval(() => { img.src = mkSrc(); }, CAM_REFRESH_MS);
        img.onerror = () => { img.alt = c.name + ' (unavailable)'; };

        const addr = document.createElement('div');
        addr.className = 'addr';
        addr.textContent = c.address;

        const footer = document.createElement('footer');
        const label = document.createElement('div'); label.textContent = c.name;
        const pill = document.createElement('div'); pill.className = 'pill'; pill.textContent = c.distkm ? c.distkm.toFixed(2) + ' km' : 'NYC DOT';
        footer.appendChild(label); footer.appendChild(pill);

        card.appendChild(img);
        card.appendChild(addr);
        card.appendChild(footer);
        wrap.appendChild(card);
      });
    }

    (async () => {
      const nearby = await getNearbyCameras();
      renderCameras(nearby);
    })();

    // --- Transit Tile (restored) ---
    (function initTransit(){
      const ORIGIN = {
        name: '34 St–Penn Station',
        detail: '(A/C/E, 1/2/3)',
        lat: 40.7523, lon: -73.9936
      };

      const DESTS = [
        { name: 'Times Square–42 St', lat: 40.7550, lon: -73.9869, via: '1 uptown or A/C/E one stop', offpeak: [5,7], peak: [6,9] },
        { name: 'Grand Central Terminal', lat: 40.7527, lon: -73.9772, via: '1/2/3 → S shuttle', offpeak: [10,15], peak: [12,18] },
        { name: 'Wall St (1)', lat: 40.7075, lon: -74.0113, via: '1 downtown direct', offpeak: [18,24], peak: [20,28] },
        { name: '161 St–Yankee Stadium', lat: 40.8296, lon: -73.9262, via: '1 uptown → D', offpeak: [28,35], peak: [32,42] },
        { name: 'JFK Terminal 4', lat: 40.6451, lon: -73.7760, via: 'E → Jamaica → AirTrain', offpeak: [55,65], peak: [60,75] },
        { name: 'LaGuardia Terminal B', lat: 40.7743, lon: -73.8719, via: 'E → Jackson Hts → Q70 SBS', offpeak: [45,55], peak: [50,65] }
      ];

      const grid = document.getElementById('transitGrid');
      const peakBadge = document.getElementById('peakBadge');

      function isPeak(now){
        const d = now || new Date();
        const dow = d.getDay(); // 0=Sun
        if (dow === 0 || dow === 6) return false; // weekends off-peak
        const h = d.getHours();
        return (h >= 7 && h < 10) || (h >= 16 && h < 19);
      }

      function cmLink(dest){
        const base = 'https://citymapper.com/directions';
        const params = new URLSearchParams({
          startcoord: ORIGIN.lat + ',' + ORIGIN.lon,
          startname: ORIGIN.name,
          startaddress: ORIGIN.name + ' ' + ORIGIN.detail + ', NYC',
          endcoord: dest.lat + ',' + dest.lon,
          endname: dest.name,
          endaddress: dest.name + ', NYC',
          lang: 'en'
        });
        return base + '?' + params.toString();
      }

      function mtaLink(dest){
        return 'https://www.mta.info/tripplanner/results';
      }

      function render(){
        const peak = isPeak();
        peakBadge.textContent = peak ? 'Peak estimate' : 'Off-peak estimate';
        grid.innerHTML = '';
        DESTS.forEach(d => {
          const [lo, hi] = peak ? d.peak : d.offpeak;
          const card = document.createElement('div');
          card.className = 'route';
          const h = document.createElement('header');
          h.innerHTML = `<div>${d.name}</div><span class="badge">${ORIGIN.name}</span>`;
          const eta = document.createElement('div');
          eta.className = 'eta';
          eta.textContent = `${lo}–${hi} min`;
          const via = document.createElement('div');
          via.className = 'via';
          via.textContent = d.via;
          const actions = document.createElement('div');
          actions.className = 'actions';
          const a1 = document.createElement('a');
          a1.className = 'btn';
          a1.href = cmLink(d);
          a1.target = '_blank';
          a1.rel = 'noopener';
          a1.textContent = 'Open Citymapper (live)';
          const a2 = document.createElement('a');
          a2.className = 'btn';
          a2.href = mtaLink(d);
          a2.target = '_blank';
          a2.rel = 'noopener';
          a2.textContent = 'MTA Trip Planner';
          actions.appendChild(a1);
          actions.appendChild(a2);

          card.appendChild(h);
          card.appendChild(eta);
          card.appendChild(via);
          card.appendChild(actions);
          grid.appendChild(card);
        });
      }

      render();
      setInterval(render, 60 * 1000);
    })();
  </script>
</body>
</html>
